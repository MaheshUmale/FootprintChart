<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Footprint Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Footprint Chart</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
                <div id="chart" class="w-full h-96 bg-white rounded-lg shadow-md"></div>
                <div id="cvd-chart" class="w-full h-48 mt-4 bg-white rounded-lg shadow-md"></div>
            </div>
            <div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-2">Open Interest</h2>
                    <div id="oi-data" class="text-gray-700">Loading...</div>
                </div>
                <div class="bg-white p-4 mt-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-2">Instruments</h2>
                    <select id="instrument-select" class="w-full p-2 border rounded-md"></select>
                    <div class="flex items-center mt-2">
                        <select id="replay-speed-select" class="w-full p-2 border rounded-md">
                            <option value="0">No Delay</option>
                            <option value="10">10ms</option>
                            <option value="20">20ms</option>
                            <option value="50">50ms</option>
                            <option value="100">100ms</option>
                        </select>
                        <button id="replay-button" class="w-full bg-blue-500 text-white p-2 ml-2 rounded-md">Replay Chart</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const chart = echarts.init(document.getElementById('chart'));
            const cvdChart = echarts.init(document.getElementById('cvd-chart'));
            const oiDataElement = document.getElementById('oi-data');
            const instrumentSelect = document.getElementById('instrument-select');
            const replayButton = document.getElementById('replay-button');
            const socket = io();

            let footprintData = [];
            let cvdData = [];

            function renderCvdChart(data) {
                const options = {
                    tooltip: {
                        trigger: 'axis'
                    },
                    xAxis: {
                        type: 'category',
                        data: data.map(item => item.ts)
                    },
                    yAxis: {
                        type: 'value',
                        name: 'CVD'
                    },
                    series: [
                        {
                            name: 'CVD',
                            type: 'line',
                            data: data.map(item => item.cvd)
                        }
                    ]
                };
                cvdChart.setOption(options);
            }

            function updateCvdData(newData) {
                const { ts, footprint } = newData;
                const buyVolume = Object.values(footprint).reduce((total, a) => total + a.buy, 0);
                const sellVolume = Object.values(footprint).reduce((total, a) => total + a.sell, 0);
                const cvd = buyVolume - sellVolume;

                cvdData.push({ ts, cvd });
                renderCvdChart(cvdData);
            }

            function renderChart(data) {
                const options = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: data.map(item => item.price)
                    },
                    yAxis: {
                        type: 'value',
                        name: 'Volume'
                    },
                    series: [
                        {
                            name: 'Buy Volume',
                            type: 'bar',
                            stack: 'total',
                            label: { show: true },
                            emphasis: { focus: 'series' },
                            data: data.map(item => item.buy)
                        },
                        {
                            name: 'Sell Volume',
                            type: 'bar',
                            stack: 'total',
                            label: { show: true },
                            emphasis: { focus: 'series' },
                            data: data.map(item => item.sell)
                        },
                        {
                            name: 'Volume Bubbles',
                            type: 'custom',
                            renderItem: function (params, api) {
                                const item = data[params.dataIndex];
                                const [price, volume] = api.value();
                                const [x, y] = api.coord([price, volume]);
                                const width = api.size([1, 0])[0] * 0.8;
                                const height = api.size([0, 1])[1];
                                return {
                                    type: 'group',
                                    children: [
                                        {
                                            type: 'rect',
                                            shape: {
                                                x: x - width / 2,
                                                y: y - height / 2,
                                                width: width,
                                                height: height
                                            },
                                            style: {
                                                fill: 'rgba(255, 215, 0, 0.5)'
                                            }
                                        },
                                        {
                                            type: 'text',
                                            style: {
                                                text: `${item.buy} | ${item.sell}`,
                                                x: x,
                                                y: y,
                                                textAlign: 'center',
                                                textVerticalAlign: 'middle'
                                            }
                                        }
                                    ]
                                };
                            },
                            data: data.map(item => [item.price, (item.buy + item.sell)])
                        }
                    ]
                };
                chart.setOption(options);
            }

            function updateFootprintData(newData) {
                const { ts, footprint } = newData;
                const formattedData = Object.entries(footprint).map(([price, volumes]) => ({
                    price,
                    buy: volumes.buy,
                    sell: volumes.sell
                })).sort((a, b) => parseFloat(b.price) - parseFloat(a.price));

                footprintData = formattedData;
                renderChart(footprintData);
            }

            socket.on('connect', () => {
                console.log('Connected to WebSocket');
            });

            socket.on('footprint_data', (data) => {
                updateFootprintData(data);
                updateCvdData(data);
            });

            socket.on('footprint_update', (data) => {
                updateFootprintData(data);
                updateCvdData(data);
            });

            fetch('/api/instruments')
                .then(response => response.json())
                .then(instruments => {
                    instruments.forEach(instrument => {
                        const option = document.createElement('option');
                        option.value = instrument;
                        option.textContent = instrument;
                        instrumentSelect.appendChild(option);
                    });
                });

            function fetchOIData(instrument) {
                fetch(`/api/oi_data/${instrument}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            oiDataElement.innerHTML = `<p class="text-red-500">${data.error}</p>`;
                        } else {
                            oiDataElement.innerHTML = `
                                <p><strong>Open Interest:</strong> ${data.open_interest}</p>
                                <p><strong>OI Change:</strong> ${data.oi_change}</p>
                            `;
                        }
                    });
            }

            instrumentSelect.addEventListener('change', (event) => {
                const selectedInstrument = event.target.value;
                socket.emit('change_security', selectedInstrument);
                fetchOIData(selectedInstrument);
            });

            replayButton.addEventListener('click', () => {
                const selectedInstrument = instrumentSelect.value;
                const replaySpeed = document.getElementById('replay-speed-select').value;
                footprintData = [];
                renderChart(footprintData);
                socket.emit('replay_market_data', { instrument_key: selectedInstrument, speed: replaySpeed });
            });

            // Fetch initial OI data
            fetch('/api/instruments')
                .then(response => response.json())
                .then(instruments => {
                    if (instruments.length > 0) {
                        fetchOIData(instruments[0]);
                    }
                });
        });
    </script>
</body>
</html>